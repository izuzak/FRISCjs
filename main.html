<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="FRISCjs - FRISC processor simulator in JavaScript" />
    <meta name="author" content="Ivan Zuzak" />
    
    <title> FRISCjs - FRISC processor simulator in JavaScript</title>
    
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" />
    <link rel="stylesheet" href="ace-mode-frisc.css" />
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
    <script type="text/javascript" src="friscasm.js"></script>
    <script type="text/javascript" src="friscjs.js"></script>
    <script type="text/javascript" src="https://raw.github.com/ajaxorg/ace-builds/master/src/ace.js"></script>
    <script type="text/javascript" src="http://twitter.github.com/bootstrap/assets/js/bootstrap-tab.js"></script>
    <script type="text/javascript" src="http://twitter.github.com/bootstrap/assets/js/bootstrap-button.js"></script>
    <script type="text/javascript" src="https://raw.github.com/madrobby/keymaster/master/keymaster.js"></script>
    <script type="text/javascript" src="https://raw.github.com/janl/mustache.js/master/mustache.js"></script>
    <script type="text/javascript" src="ace-mode-frisc.js"></script>
    <style>
      #cpustate {
        margin-top: 8px;
      }
  
      .cpu-state-div {
        font-size: 12pt; 
        margin-top: 2px; 
        display: inline-block; 
        height: 40px; 
        border: 1px solid rgb(102, 102, 102);
        width: 160px; 
        margin-right: 2px;
      }
      
      .cpu-reg-label {
        width: 54px; 
      }
      
      .cpu-reg-value {
        width: 105px; 
      }

      .cpu-sr-label {
        width:105px; 
      }
      
      .cpu-sr-value {
        width: 54px; 
      }
      
      .cpu-state-lab { 
        height: 40px; 
        border-right: 1px solid rgb(102, 102, 102);
        background-color: #D4CDCF; 
        display: table-cell;
        vertical-align: middle;
        text-align: center;
        font-weight: bold;
      }
      
      .cpu-state-val {
        height: 40px; 
        background-color: rgba(230, 228, 228, 0.53); 
        display: table-cell;
        vertical-align: middle;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container" style="width: 1140px">
      <h1> FRISCjs <small> FRISC processor simulator in JavaScript </small> </h1>
      <ul class="nav nav-tabs">
        <li class="active"><a href="#frisc-sim" data-toggle="tab">Simulator</a></li>
        <li><a href="#frisc-usage" data-toggle="tab">Usage instructions</a></li>
        <li><a href="#frisc-about" data-toggle="tab">About</a></li>
      </ul>
      <div class="tab-content" style="margin-bottom: 20px;">
        <div id="frisc-usage" class="container tab-pane" style="width: auto;">
          <div class="well">
            <h3> Usage instructions </h3>
            <ol>
              <li> Enter your FRISC assembler program into the textbox on the left. Note: the simulator has a memory module of 256KB, i.e. from 0x00000000 to 0x0003FFFF.</li>
              <li> Press the <b>"Settings"</b> button to define the CPU speed (in Hz, default is 1000) and the memory size (in KB, default is 256KB, min is 1KB, max is 1000KB). </li>
              <li> Press the <b>"Load"</b> button to parse the program and load it into memory. In case of parsing errors, the error message, line and column numbers will be logged to the output screen.</li>
              <li> After the program loads into memory, the program editor is replaced with a location-by-location view of the complete memory. For each location, the location address, value, and value interpreted as a FRISC instruction are show. The location address may be displayed as either a decimal or hexadecimal number by pressing either the <b>"DEC"</b> or <b>"HEX"</b> buttons (defaul is hexadecimal). Furthermore, the search-box underneath the memory view provides a fast way to jump to any location.</li>
              <li> Press the <b>"Run all"</b> button to start the CPU.</li>
              <li> Press the <b>"Run one"</b> button to force the CPU to execute the next instruction.</li>
              <li> Press the <b>"Pause"</b> button to pause CPU execution.</li>
              <li> Press the <b>"Stop"</b> button to stop the CPU completely and return to defining the program.  </li>
              <li> Press the <b>"Clear log"</b> button to clear the log output screen. </li>
            </ol>
            <p>
              More information about FRISC is available <a href="http://www.fer.unizg.hr/_download/repository/knjiga_FRISC_izvadak.pdf">here</a> (in Croatian), while a cheat sheet for the FRISC instruction set and IO units is available <a href="http://www.fer.unizg.hr/_download/repository/salabahter_cijeli.pdf">here</a> (in Croatian).
            </p>
          </div>
        </div>
        <div id="frisc-about" class="container tab-pane" style="margin-bottom: 20px; width: auto;">
          <div class="well">
            <h3> About </h3>
            <p>
              FRISCjs is a simulator of the FRISC processor written in JavaScript.
              <a href="http://www.fer.unizg.hr/rasip/knjige/frisc">FRISC</a> is a simple, educational RISC processor developed at the <a href="http://fer.unizg.hr/en">University of Zagreb, Faculty of Electrical Engineering and Computing</a>.
              The simulator has two parts: a <a href="https://github.com/izuzak/FRISCjs/blob/master/friscasm.pegjs">FRISC assembler</a> (built using PEGjs) which translates FRISC assembly code to machine code and a <a href="https://github.com/izuzak/FRISCjs/blob/master/friscjs.js">FRISC CPU simulator</a> which executes machine code.
              This Web application is a graphical interface for the simulator, while there also exists a <a href="https://github.com/izuzak/FRISCjs/blob/master/main.js">console interface which runs on NodeJS</a>.
            </p>

            <h3> Source code and bug reports </h3>
              <p>
                The complete source code for FRISCjs and this Web application is <a href="https://github.com/izuzak/FRISCjs">available on GitHub</a>.
                Please use the GitHub <a href="https://github.com/izuzak/FRISCjs/issues">issue tracker</a> for reporting bugs and feature requests.
              </p>
            <h3> Credits and license </h3>
              <p>
                FRISCjs was developed by <a href="http://ivanzuzak.info">Ivan Zuzak</a>. License: <a href="https://github.com/izuzak/FRISCjs/blob/master/LICENSE.markdown">Apache 2.0.</a> Contributors: <a href="https://github.com/ibudiselic">Ivan Budiselic</a>, <a href="https://github.com/Stankec">Stanko Krtalic</a>.
              </p>
              <p>
                FRISCjs is built with many open-source projects: <a href="http://pegjs.majda.cz/">PEGjs</a>, <a href="http://nodejs.org">NodeJS</a>, <a href="http://jquery.com">jQuery</a>, <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, <a href="http://ace.ajax.org/">Ace</a> and <a href="https://github.com/madrobby/keymaster">Keymaster</a>.
              </p>
          </div>
        </div>
        <div id="frisc-sim" class="active container-fluid tab-pane" style="padding-left: 0px;">
          <div id="frisc-inputdiv" class="sidebar" style="width: 450px; height: 500px;">
          </div>

          <div class="sidebar ace_editor ace-tm" id="frisc-memorylist-hold" style="width: 450px; height: 495px; display:none;">
            <div style="width: 448px; height: 30px; display:inline-block;  position:absolute; top:0px; border: 1px solid #dddddd; border-collapse: separate; border-radius: 4px 4px 0px 0px; background-color:#f1f1f1; padding-top:5px;">
              <div style='display:inline-block; width:40px;  border-right: 1px solid #000000; padding-left: 4px; vertical-align: middle; padding-top: 1px;'>#</div>
              <div style='display:inline-block; width:185px; border-right: 1px solid #000000; padding-left: 4px; vertical-align: middle; padding-top: 1px;'>Value</div>
              <div style='display:inline-block; width:100px;  padding-left: 4px; vertical-align: middle; padding-top: 1px;'>Command</div>
            </div>

            <div id="frisc-memorylist" style="width: 448px; height: 422px; position:absolute; top:31px; overflow: scroll; overflow-x:hidden; display:inline-block; border: 1px solid #dddddd; border-radius: 0px 0px 4px 4px;">
            </div>

            <div id="frisc-memorylist-search" style="border: 1px solid #dddddd; border-collapse: separate; border-radius: 0px 0px 4px 4px; background-color:#f1f1f1; position:absolute; bottom:0px; width: 448px; height: 35px; padding-top: 6px;">
              <div style="padding-left: 6px;">
                  <input  type="text" class="input-medium search-query" id="skrMemLisSearchField">
                  <button type="submit" class="btn" id="skrMemLisSearch">Go to</button>
                  <div class="btn-group" data-toggle="buttons-radio" style="display:inline-block; vertical-align: middle;">
                        <button class="btn"         id="skrBaseRadioDec">DEC</button>
                        <button class="btn active"  id="skrBaseRadioHex">HEX</button>
                  </div>
              </div>
            </div>
          </div>

          <div class="content" style="margin-left: 460px; height: 500px;">
          <div id="frisc-controls" style="float: left; margin-left: 10px;">
            <div id="frisc-cpu-controls" class="form-inline" style="width: 666px;">
              <button id="frisc-load" type="button" class="btn btn-success"><i class="icon-download-alt icon-white"></i> Load</button>
              <button id="frisc-execute" type="button" class="btn btn-primary"><i class="icon-fast-forward icon-white"></i> Run all</button>
              <button id="frisc-next" type="button" class="btn btn-primary"><i class="icon-step-forward icon-white"></i> Run one</button>
              <button id="frisc-pause" type="button" class="btn btn-primary"><i class="icon-pause icon-white"></i> Pause</button>
              <button id="frisc-stop" type="button" class="btn btn-danger"><i class="icon-stop icon-white"></i> Stop</button>
              <button id="frisc-clear" type="button" class="btn btn-primary"><i class="icon-remove-sign icon-white"></i> Clear log</button>
              <button id="frisc-showhidesettings" type="button" class="btn btn-primary" data-toggle="button"><i class="icon-wrench icon-white"></i> Settings</button>
            </div>
            <div id="frisc-settings" style="display: none; margin-top: 15px;" class="form-inline">
              <label for="frisc-freq" style="margin-bottom: 0px;">CPU frequency (Hz):</label>
              <input id="frisc-freq" type="number" min="1" step="1" class="input-mini" style="margin-bottom: 0px;" value="1000" />
              <label for="frisc-memsize" style="margin-bottom: 0px;">MEM size (KB):</label>
              <input id="frisc-memsize" type="number" min="1" step="1" max="1000" class="input-mini" style="margin-bottom: 0px;" value="256" />
            </div>
            <div id="cpuout" style="font-size: 10pt; font-family: courier new; background-color: #D4CDCF; width: 650px; overflow: auto; border: 1px solid #666; padding: 8px; margin-top: 15px; color: black;"></div>
            <div id="cpustate" style="margin-top: 8px;" >
              <div id="cpu_r0" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> R0 </div>
                <div class="cpu-reg-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_r1" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> R1 </div>
                <div class="cpu-reg-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_r2" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> R2 </div>
                <div class="cpu-reg-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_r3" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> R3 </div>
                <div class="cpu-reg-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_r4" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> R4 </div>
                <div class="cpu-reg-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_r5" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> R5 </div>
                <div class="cpu-reg-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_r6" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> R6 </div>
                <div class="cpu-reg-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_r7" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> R7 </div>
                <div class="cpu-reg-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_pc" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> PC </div>
                <div class="cpu-reg-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_sr" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> SR </div>
                <div class="cpu-reg-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_iif" class="cpu-state-div"> 
                <div class="cpu-reg-label cpu-state-lab"> IIF </div>
                <div class="cpu-reg-value cpu-state-val"> 1 </div>
              </div>
              <br>
              <div id="cpu_N" class="cpu-state-div"> 
                <div class="cpu-sr-label cpu-state-lab"> SR-N </div>
                <div class="cpu-sr-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_C" class="cpu-state-div"> 
                <div class="cpu-sr-label cpu-state-lab"> SR-C </div>
                <div class="cpu-sr-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_V" class="cpu-state-div"> 
                <div class="cpu-sr-label cpu-state-lab"> SR-V </div>
                <div class="cpu-sr-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_Z" class="cpu-state-div"> 
                <div class="cpu-sr-label cpu-state-lab"> SR-Z </div>
                <div class="cpu-sr-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_EINT0" class="cpu-state-div"> 
                <div class="cpu-sr-label cpu-state-lab"> SR-EINT0 </div>
                <div class="cpu-sr-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_EINT1" class="cpu-state-div"> 
                <div class="cpu-sr-label cpu-state-lab"> SR-EINT1 </div>
                <div class="cpu-sr-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_EINT2" class="cpu-state-div"> 
                <div class="cpu-sr-label cpu-state-lab"> SR-EINT2 </div>
                <div class="cpu-sr-value cpu-state-val"> 0 </div>
              </div>
              <div id="cpu_GIE" class="cpu-state-div"> 
                <div class="cpu-sr-label cpu-state-lab"> SR-GIE </div>
                <div class="cpu-sr-value cpu-state-val"> 0 </div>
              </div>
            </div>
          </div>
        </div>
        <div style="margin-bottom: 25px; width: 1140px;">
          <legend style="margin-bottom: 15px;">IO units</legend>
          <div class="form-inline" style="margin-bottom: 25px;">
            <form id="ioUnitFormStatic">
              <input class="span2" type="text" style="margin-bottom: 0px;" id="ioUnitName" required pattern="[A-Za-z_0-9]{3,}" placeholder="Enter IO unit name…" />
              <select class="span2" id="ioUnitType" required>
                <option value="">Select unit type…</option>
                <option value="generic">Generic IO unit</option>
                <option value="frisc-ct">FRISC CT</option>
                <option value="frisc-pio">FRISC PIO</option>
                <option value="frisc-dma">FRISC DMA</option>
              </select>
              <select class="span2" id="ioUnitIntLevel" required>
                <option value="">Select interrupt…</option>
                <option value="INT0">INT0 (maskable)</option>
                <option value="INT1">INT1 (maskable)</option>
                <option value="INT2">INT2 (maskable)</option>
                <option value="INT3">INT3 (unmaskable)</option>
              </select>
              <label> Memory mapping start addr (HEX): </label>
              <input type="text" class="span1" id="ioUnitMemmapStart" value="0" required/>
              <label> Number of 4B locations: </label>
              <input type="text" class="span1" id="ioUnitMemmapCount" value="0" required/>
              <button type="submit" class="btn btn-success" id="addIoUnit" value="Search"><i class="icon-plus icon-white"></i> Add</button>
            </form>
          </div>
          <div class="row" id="ioUnits">
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
      key('backspace', function(){ return false; });

      var height = ($("#frisc-inputdiv").innerHeight() - $("#frisc-cpu-controls").innerHeight()) - 281 + "px";
      $("#cpuout").height(height);
      $("#memout").height(height);

      var _state = "stopped";

      // create FRISC
      var simulator = new FRISC();
      simulator.CPU._frequency = parseFloat($("#frisc-freq").val());

      window.onload = function() {
        $(function() { $("li").css("color", "#404040"); });
        editor = ace.edit("frisc-inputdiv");
        var FriscMode = require("ace/mode/frisc").Mode;
        editor.getSession().setMode(new FriscMode());
        document.getElementById('frisc-inputdiv').style.fontSize='10pt';
        document.getElementById('frisc-inputdiv').style.fontFamily='courier new';
        $(".ace_gutter").width("40px");
        editor.getSession().setValue("; aluop\n\
lab1 ADD R1, R2, R3\n\
lab2 ADD r2, 5, r5\n\
 ADD r5, lab1, r2\n\
; cmpop\n\
 CMP R1, R2\n\
lab5 CMP R1, 5\n\
lab6 CMP r4, lab5\n\
; moveop\n\
lab7 MOVE R4, R5\n\
lab8 MOVE R5, SR\n\
lab9 MOVE SR, r5\n\
 MOVE lab5, r4\n\
lab11 MOVE lab6, sr\n\
; uprop\n\
 JP lab2\n\
 JP_N 54\n\
lab12 JP_UGE (r1)\n\
lab13 RETI_M\n\
; memop\n\
lab14 STORE r1, (r2)\n\
 STORE r4, (r3+23)\n\
 STORE r4, (lab14)\n\
lab15 STORE r5, (200)\n\
lab16 POP r3\n\
; asmop\n\
lab17 `ORG 234\n\
 `DW 1,2,3,4,5\n\
 `DW 54\n\
lab18 `EQU 300\n\
lab19 `DS 12\n\
lab21 `BASE H\n\
lab22 DW 54\n\
 DH 34\n\
 DB 12\n\
lab20 `END\n\
lab23 ADD R1, R2, R3\n\
; fds fsd';");
        editor.resize();
        editor.renderer.setHScrollBarAlwaysVisible(false);
        changeState("stopped");
      };

      function simulatorLog(text, marginLeft) {
        if (typeof text !== "string") {
          text = JSON.stringify(text);
        }

        if (typeof marginLeft === "undefined") {
          marginLeft = "0px";
        }
        
        $("#cpuout").append("<div style='margin: 1px; margin-left: " + marginLeft + "; padding: 0px;'>" + text + "</div>");
        $("#cpuout").scrollTop($("#cpuout")[0].scrollHeight);
      }

      function getBase () {
        if ($("#skrBaseRadioDec").hasClass("active")) return 10;
        return 16;
      }

      function getMemState(lower, upper) {
        var memStateString = ""; 
        var base = getBase();
        
        for (var i=lower; i>=0 && i<simulator.MEM._memory.length && i<upper; i+=4) {
          var decoded = simulator.CPU._decode(simulator.MEM.read(i));
          decoded = decoded ? " - " + instructionToString(decoded) : "";
          memStateString += i.toString(base)+ ": " + simulator.MEM.read(i).toString() + " - " + convertIntToBinary(simulator.MEM.read(i), 32) + decoded + "</br>";
        }

        return memStateString;
      }

      function createMemList(div) {
        var rowHeight = 18;
        var lastDivMessage="Back to top?"
        var ofF = 1.4;

        //Don't edit this
        var maxRows = Math.floor($('#'+div).height()/rowHeight)*ofF;
        maxRows = maxRows ? maxRows : 100;
        if(Math.floor(maxRows/2)*2 == maxRows) maxRows++;

        var base = getBase();
        var decoded = "";
        var bgColor = "#ffffff";
        $("#"+div).html("");
        
        for (var i=0; i>=0 && i<maxRows*4 && i<simulator.MEM._memory.length; i+=4) {
          decoded = simulator.CPU._decode(simulator.MEM.read(i));
          decoded = decoded ? instructionToString(decoded) : "";
          if (decoded == "MOVE r0 r0") decoded="";

          bgColor = (((i/4)%2)==0) ? "#ffffff" : "#f8f8f8";

          $("#"+div).html($("#"+div).html()+"<div style='height:"+rowHeight+"px; width:100%; background-color:"+bgColor+"; position:absolute; top:"+((i/4)*rowHeight)+"px; border: 1px solid #dfdfdf;'>"+
                                              "<div style='display:inline-block; width:10%; border-right: 1px solid #dfdfdf;' class='memoryTableNumbering'>"+i.toString(base)+"</div>"+
                                              "<div style='display:inline-block; width:44%; border-right: 1px solid #dfdfdf;' class='memoryTableValue'>"+simulator.MEM.read(i).toString()+"</div>"+
                                              "<div style='display:inline-block; width:44%;'>"+decoded+"</div>"+
                                            "</div>");
        }

        $("#"+div).html($("#"+div).html()+"<div style='height:"+rowHeight+"px; background-color:#f1f1f1; position:relative; top:"+((simulator.MEM._memory.length/4)*rowHeight)+"px; border-radius: 0px 0px 4px 4px;'>"+lastDivMessage+"</div>");
        
        var prevScrollPos = 0;
        $("#"+div).scroll(function(){

          //Normal scrolling
          if  (prevScrollPos > $("#"+div).scrollTop()) { //scrolled UP
            $("#"+div).children().each(function(){
              if (($(this).position().top>$("#"+div).height()) && ($(this).html()!=lastDivMessage)){
                //Find the lowest child and it's value
                var highest = simulator.MEM._memory.length*rowHeight; //highest possible position
                var highVal = (simulator.MEM._memory.length*rowHeight);
                $("#"+div).children().each(function(){
                  if (parseInt($(this).css("top").replace("px",""))<highest) {
                    highest = parseInt($(this).css("top").replace("px",""));
                    highVal = parseInt($(this).children().html(),base);
                  }
                });

                highVal = highVal - 4;
                if (highVal>=0) { 
                  base = getBase();
                  $(this).css({ top: ''+(highest-rowHeight)+'px' });
                  decoded = simulator.CPU._decode(simulator.MEM.read(highVal));
                  decoded = decoded ? instructionToString(decoded) : "";
                  if (decoded == "MOVE r0 r0") decoded="";

                  bgColor = (((highVal/4)%2)==0) ? "#ffffff" : "#f8f8f8";
                  $(this).css("background-color",''+bgColor );

                  $(this).html(""+"<div style='display:inline-block; width:10%; border-right: 1px solid #dfdfdf;' class='memoryTableNumbering'>"+highVal.toString(base)+"</div>"+
                                  "<div style='display:inline-block; width:44%; border-right: 1px solid #dfdfdf;'>"+simulator.MEM.read(highVal).toString()+"</div>"+
                                  "<div style='display:inline-block; width:44%;'>"+decoded+"</div>");
                }
              }
            });
          } else { //scrolled DOWN
            $("#"+div).children().each(function(){
              if (($(this).position().top<(-1*rowHeight)) && ($(this).html()!=lastDivMessage)){
                //Find the lowest child and it's value
                var highest = simulator.MEM._memory.length*rowHeight*-1; //highest possible position
                var highVal = 0;
                $("#"+div).children().each(function(){
                  if ((parseInt($(this).css("top").replace("px",""))>highest) && ($(this).html()!=lastDivMessage)) {
                    highest = parseInt($(this).css("top").replace("px",""));
                    highVal = parseInt($(this).children().html(),base);
                  }
                });
                highVal = highVal + 4;
                if (highVal<simulator.MEM._memory.length) { 
                  base = getBase();
                  $(this).css({ top: ''+(highest+rowHeight)+'px' });

                  decoded = simulator.CPU._decode(simulator.MEM.read(highVal));
                  decoded = decoded ? instructionToString(decoded) : "";
                  if (decoded == "MOVE r0 r0") decoded="";

                  bgColor = (((highVal/4)%2)==0) ? "#ffffff" : "#f8f8f8";
                  $(this).css("background-color",''+bgColor );

                  $(this).html(""+"<div style='display:inline-block; width:10%; border-right: 1px solid #dfdfdf;' class='memoryTableNumbering'>"+highVal.toString(base)+"</div>"+
                                  "<div style='display:inline-block; width:44%; border-right: 1px solid #dfdfdf;'>"+simulator.MEM.read(highVal).toString()+"</div>"+
                                  "<div style='display:inline-block; width:44%;'>"+decoded+"</div>");
                }
              }
            });
          };

          prevScrollPos = $("#"+div).scrollTop();

          //Check if the user scrolled too fast
          var invisibleCounter = 0;
          $("#"+div).children().each(function() { if ( (($(this).position().top>$("#"+div).height()) || ($(this).position().top<0)) && ($(this).html()!=lastDivMessage)) { invisibleCounter++; }; });
          if (invisibleCounter >= maxRows)  { //If all rows are invisible
            var i = Math.floor((prevScrollPos / rowHeight)) * 4;
            var x = i; //visual bug fix
            $("#"+div).children().each(function(){
              if (($(this).html()!=lastDivMessage) && (i<simulator.MEM._memory.length) && (i>=0)) {
                base = getBase();
                decoded = simulator.CPU._decode(simulator.MEM.read(i));
                decoded = decoded ? instructionToString(decoded) : "";
                if (decoded == "MOVE r0 r0") decoded="";

                bgColor = (((i/4)%2)==0) ? "#ffffff" : "#f8f8f8";

                $(this).css({ top: ''+((i/4)*rowHeight)+'px' });

                $(this).html( "<div style='display:inline-block; width:10%; border-right: 1px solid #dfdfdf;' class='memoryTableNumbering'>"+i.toString(base)+"</div>"+
                              "<div style='display:inline-block; width:44%; border-right: 1px solid #dfdfdf;'>"+simulator.MEM.read(i).toString()+"</div>"+
                              "<div style='display:inline-block; width:44%;'>"+decoded+"</div>");
                i += 4;
              } else if (($(this).html()!=lastDivMessage) && (i>=simulator.MEM._memory.length) && (i>=0) && (x>=0)) { //visual bug fix
                //fixes minor glitching when the user drags the scroller to the bottom of the memory view;
                base = getBase();
                decoded = simulator.CPU._decode(simulator.MEM.read(x));
                decoded = decoded ? instructionToString(decoded) : "";
                if (decoded == "MOVE r0 r0") decoded="";

                bgColor = (((x/4)%2)==0) ? "#ffffff" : "#f8f8f8";

                $(this).css({ top: ''+((x/4)*rowHeight)+'px' });

                $(this).html( "<div style='display:inline-block; width:10%; ' class='memoryTableNumbering'>"+x.toString(base)+"</div>"+
                              "<div style='display:inline-block; width:45%; '>"+simulator.MEM.read(x).toString()+"</div>"+
                              "<div style='display:inline-block; width:45%; '>"+decoded+"</div>");
                i += 4;
                x -= 4;
              };
            });
          };
        });
      }

      function changeState(st) {
        if (st === "stopped") {
          enableElements(["#frisc-load", "#frisc-freq", "#frisc-memsize", ".io-del", "#addIoUnit"]);
          disableElements(["#frisc-execute", "#frisc-next", "#frisc-pause", "#frisc-stop"]);
          _state = st;
        } else if (st ==="loaded") {
          enableElements(["#frisc-execute", "#frisc-next", "#frisc-stop"]);
          disableElements(["#frisc-load", "#frisc-pause", "#frisc-freq", "#frisc-memsize", ".io-del", "#addIoUnit"]);
          _state = st;
        } else if (st === "running") {
          enableElements(["#frisc-stop", "#frisc-pause", "#frisc-next"]);
          disableElements(["frisc-execute", "#frisc-load", "#frisc-freq", "#frisc-memsize", ".io-del", "#addIoUnit"]);
          _state = st;
        }
      }

      function enableElements(elems) {
        for (var i=0; i<elems.length; i++) {
          $(elems[i]).attr('disabled', false);
        }
      }

      function disableElements(elems) {
        for (var i=0; i<elems.length; i++) {
          $(elems[i]).attr('disabled', true);
        }
      }

      function cpuStateToString() {
        var retVal = "";
        
        for (var key in simulator.CPU._r) {
          if (key !== 'sr') {
            retVal += key + ": " + simulator.CPU._r[key].toString() + " ";
          } else {
            retVal += key + ": " + simulator.CPU._r[key].toString() + " ( ";
            for (var flag in simulator.CPU._f) {
              retVal += flag + ": " + simulator.CPU._getFlag(simulator.CPU._f[flag]) + " ";
            }
            retVal += ") ";
          }
        }

        return retVal;
      }

      function instructionToString(instruction) {
        if (typeof instruction.args === 'undefined' || instruction.args === null) {
          return instruction.op;
        } else {
          if (instruction.op === 'RET' && instruction.args[1] === true) {
            return 'RETI ' + instruction.args[0];
          } else if (instruction.op === 'RET' && instruction.args[2] === true) {
            return 'RETN ' + instruction.args[0];
          } else if (instruction.op === 'RET') {
            return 'RET ' + instruction.args[0];
          } else {
            return instruction.op + " " + instruction.args.join(" ");
          }
        }
      }
      
      function updateCpuState() {
        for (var key in simulator.CPU._r) {
          $("#cpu_" + key + " .cpu-state-val").text(simulator.CPU._r[key]);
        }
        
        for (var flag in simulator.CPU._f) {
          $("#cpu_" + flag + " .cpu-state-val").text(simulator.CPU._getFlag(simulator.CPU._f[flag]));
        }
      }
      
      simulator.CPU.onBeforeRun = function() {
        simulatorLog("<span style='padding: 2px 4px 1px'; class='label label-success'><b>Starting (or continuing) simulation!</b></span>");
      };
      
      simulator.CPU.onBeforeCycle = function() {
        simulatorLog("<span style='padding: 2px 4px 1px'; class='label label-success'><b>New CPU cycle starting!</b></span>");
        simulatorLog("<span style='padding: 2px 4px 1px'; class='label label-info'>CPU state:</span>" + " " + cpuStateToString(), "10px");
      };
      
      simulator.CPU.onAfterCycle = function() {
        simulatorLog("<span style='padding: 2px 4px 1px'; class='label label-info'>CPU state:</span>" + " " + cpuStateToString(), "10px");
        updateCpuState();
      };

      simulator.CPU.onBeforeExecute = function(instruction) {
        simulatorLog("<span style='padding: 2px 4px 1px'; class='label label-info'>Executing FRISC instruction:</span>" + " " + instructionToString(instruction), "10px");
      };
      
      simulator.CPU.onStop = function() {
        simulatorLog("<span style='padding: 2px 4px 1px'; class='label label-warning'><b>FRISC processor stopped!</b></span>");
        changeState("stopped");
        onStopInternal();
      };

      $("#frisc-load").click(function() {
        if (_state === "stopped") {
          try {
            simulator.CPU.reset();
            
            var ioUnits = simulator.IO.getIoUnits();

            for (var i=0; i<ioUnits.length; i++) {
              simulator.IO.getIoUnit(ioUnits[i]).reset();
            }
            
            var source = editor.getSession().getValue();
            if (source.length > 0 && source[source.length-1] !== '\n') {
              source += '\n';
            }
            var result = frisc_asm.parse(source);
          } catch (e) {
            simulatorLog("<span style='padding: 2px 4px 1px'; class='label label-important'><b>Parsing error</b></span> on line " + e.line + " column " + e.column + " -- " + e.toString() + "");
            return;
          }

          try {
            simulator.CPU._frequency = parseInt($("#frisc-freq").val());
            simulator.MEM._size = parseInt($("#frisc-memsize").val()) * 1024;
            simulator.MEM.loadBinaryString(result.mem);
          } catch (e) {
            simulatorLog("<span style='padding: 2px 4px 1px'; class='label label-important'><b>Loading error</b></span>" + " -- " + e.toString() + "");
            return
          }

          simulatorLog("<span style='padding: 2px 4px 1px'; class='label label-success'><b>Input program parsed successfully.</b></span>");
          changeState("loaded");

          //Show the memory list
          $("#frisc-inputdiv").hide("medium");
          $("#frisc-memorylist-hold").show("medium");
          createMemList("frisc-memorylist");
          updateCpuState();
        }
      });

      $("#frisc-execute").click(function() {
        if (_state === "loaded") {
          simulator.CPU.run();
          changeState("running");
        }
      });

      $("#frisc-stop").click(function() {
        if (_state === "running" || _state === "loaded") {
          simulator.CPU.stop();
        }
      });
      
      function onStopInternal() {
        //Hide the memory list
        $("#frisc-inputdiv").show("fast");
        $("#frisc-memorylist-hold").hide("fast");
        
        if ($("#frisc-memorylist-search").is(":visible")) {
          $('#frisc-memorylist-searchtoggle').click();
        }
        
        if ($("#frisc-memorylist-settings").is(":visible")) {
          $('#frisc-memorylist-settingstoggle').click();
        }
      }

      $("#frisc-next").click(function() {
        if (_state === "running" || _state === "loaded") {
          simulator.CPU.performCycle();
        }
      });

      $("#frisc-pause").click(function() {
        if (_state === "running") {
          simulator.CPU.pause();
          changeState("loaded");
        }
      });

      $("#frisc-clear").click(function() {
        $("#cpuout").html("");
      });
      
      $("#frisc-showhidesettings").click(function() {
        if ($("#frisc-settings").is(":visible")) {
          $('#cpuout').animate({ height: height }, 603, function() {;} );
          $("#frisc-settings").hide("slow");
        } else {
          $('#cpuout').animate({ height: parseInt(height)-$("#frisc-settings").outerHeight(true) }, 603, function() {;} );
          $("#frisc-settings").show("slow");
        }
      });

      //memorylist search
      $("#skrMemLisSearch").click(function() {
        var searcher = parseInt($("#skrMemLisSearchField").val(), getBase())/4;
        $('#frisc-memorylist').animate({scrollTop: (18*searcher)}, 1000 ,function() {;});
      });

      //memorylist numbering
      $("#skrBaseRadioDec").click(function() {
        if ($("#skrBaseRadioDec").attr('class')=="btn active") return;
        $(".memoryTableNumbering").each(function(){
          $(this).html(parseInt($(this).html(), 16).toString(10));
        });
      });
      $("#skrBaseRadioHex").click(function() {
        if ($("#skrBaseRadioHex").attr('class')=="btn active") return;
        $(".memoryTableNumbering").each(function(){
          $(this).html(parseInt($(this).html(), 10).toString(16));
        });
      });
    </script>
    <script type="text/javascript">
      var ioUnitMustacheTemplate = ' \
        <div id="iounit-{{id}}" class="form-inline" style="-moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px; -moz-box-shadow: 0px 0px 4px #000000; -webkit-box-shadow: 0px 0px 4px #000000; box-shadow: 0px 0px 4px #000000; padding: 5px; margin-left: 20px; margin-bottom:20px; width: 550px; float: left;"> \
          <div class="form-inline" style="margin-bottom: 10px;"> \
            <button type="button" class="io-del btn btn-danger"><i class="icon-remove-sign icon-white"></i></button> \
            <label class="btn" style="font-size: 20px; color: black; opacity: 1;" disabled><b> {{name}}</b>, {{summary}} </label>\
          </div> \
          {{#intLevel}} \
          <div class="form-inline" style="margin-bottom: 10px;"> \
            <label>Interrupt state ({{intLevel}}):</label> \
            {{#areFieldsEditable}} \
            <input type="text" class="input-mini io-int" value="0" /> \
            {{/areFieldsEditable}} \
            {{^areFieldsEditable}} \
            <span class="uneditable-input input-mini io-int" value="0">0</span> \
            {{/areFieldsEditable}} \
          </div> \
          {{/intLevel}} \
          <table class="table table-bordered table-condensed" style="margin-bottom: 5px;"> \
            <thead> \
              <tr> \
                <th> Address HEX </th> \
                <th style="width: 90px;"> Value HEX </th> \
                <th style="width: 90px;"> Value DEC </th> \
                <th style="width: 240px;"> Value BIN </th> \
              </tr> \
            </thead> \
            <tbody> \
              {{#addresses}} \
              <tr class="io-loc-{{loc}}"> \
                <td> <span class="uneditable-input io-loc" style="width: 75px;"> {{lochex}} </span> </td> \
                {{#areFieldsEditable}} \
                <td> <input type="text" style="width: 80px;" class="input io-mem-hex" value="{{hex}}" /> </td> \
                <td> <input type="text" style="width: 80px;" class="input io-mem-dec" value="{{dec}}" /> </td> \
                <td> <input type="text" style="width: 230px;" class="input io-mem-bin" value="{{bin}}" /> </td> \
                {{/areFieldsEditable}} \
                {{^areFieldsEditable}} \
                <td> <span style="width: 80px;" class="uneditable-input io-mem-hex" value="{{hex}}"> {{hex}} </span> </td> \
                <td> <span style="width: 80px;" class="uneditable-input io-mem-dec" value="{{dec}}"> {{dec}} </span> </td> \
                <td> <span style="width: 230px;" class="uneditable-input io-mem-bin" value="{{bin}}"> {{bin}} </span> </td> \
                {{/areFieldsEditable}} \
              </tr> \
              {{/addresses}} \
            </tbody> \
          </table> \
          </div>';
      $("#ioUnitType").change(function () {
        $("#ioUnitFormDynamic").html("");
        $("#frisc-ct-freq").remove();
        $("#frisc-ct-freq-label").remove();
        $("#frisc-pio-freq").remove();
        $("#frisc-pio-freq-label").remove();
        
        if ($(this).val() === 'generic') {
          defineGenericIoUnitTypeForm();
        } else if ($(this).val() === 'frisc-ct') {
          defineFriscCtIoUnitTypeForm();
        } else if ($(this).val() === 'frisc-pio') {
          defineFriscPioIoUnitTypeForm();
        } else if ($(this).val() === 'frisc-dma') {
          defineFriscDmaIoUnitTypeForm();
        }
      });
      
      function convertIoUnitNameToId(ioUnitName) {
        return ioUnitName.toLowerCase();
      }
      
      $("#ioUnitFormStatic").submit(function() {
        var ioUnitName = $("#ioUnitName").val();
        var ioUnitId = convertIoUnitNameToId(ioUnitName);
        var intLevel = parseInt($("#ioUnitIntLevel").val()[3]);
        var memmapStart = parseInt($("#ioUnitMemmapStart").val(), 16);
        var memmapCount = parseInt($("#ioUnitMemmapCount").val(), 10);
        
        var addresses = [];
        
        for (var i=0; i<memmapCount; i++) {
          addresses.push({hex : 0, bin : 0, dec : 0, loc : i*4 + memmapStart, lochex : formatHexNumber((i*4 + memmapStart).toString(16), 8)});
        }
        
        var d = {
          id : ioUnitId,
          name : ioUnitName,
          intLevel : (intLevel !== null) ? "INT" + intLevel : intLevel,
          addresses : addresses,
        };
        
        if (($("#ioUnitType").val() === 'generic')) {   
          d.summary = "Generic IO unit";
          d.areFieldsEditable = true;
        } else if ($("#ioUnitType").val() === 'frisc-ct') {
          var frequency = parseInt($("#frisc-ct-freq").val());
          d.summary = "FRISC-CT unit, " + frequency + "Hz";
          d.areFieldsEditable = false;
          d.freq = frequency;
        } else if ($("#ioUnitType").val() === 'frisc-pio') {
          var frequency = parseInt($("#frisc-pio-freq").val());
          d.summary = "FRISC-PIO unit, " + frequency + "Hz";
          d.areFieldsEditable = false;
          d.freq = frequency;
        } else if ($("#ioUnitType").val() === 'frisc-dma') {
          d.summary = "FRISC-DMA unit";
          d.areFieldsEditable = false;
        }
        
        try {
          var ioUnit = null;
          if (($("#ioUnitType").val() === 'generic')) {
            ioUnit = simulator.IO.createGenericIoUnit(ioUnitId, { memMapAddrCount : memmapCount, memMapAddrStart : memmapStart, intLevel : intLevel});
          } else if ($("#ioUnitType").val() === 'frisc-ct') {
            ioUnit = simulator.IO.createFriscCtIoUnit(ioUnitId, { memMapAddrCount : memmapCount, memMapAddrStart : memmapStart, intLevel : intLevel, frequency : d.freq });
          } else if ($("#ioUnitType").val() === 'frisc-pio') {
            ioUnit = simulator.IO.createFriscPioIoUnit(ioUnitId, { memMapAddrCount : memmapCount, memMapAddrStart : memmapStart, intLevel : intLevel, frequency : d.freq });
          } else if ($("#ioUnitType").val() === 'frisc-dma') {
            ioUnit = simulator.IO.createFriscDmaIoUnit(ioUnitId, { memMapAddrCount : memmapCount, memMapAddrStart : memmapStart, intLevel : intLevel });
          }
        
          simulator.IO.addIoUnit(ioUnit);
          
          var s = Mustache.render(ioUnitMustacheTemplate, d);
          $("#ioUnits").append(s);
          
          $("#iounit-" + ioUnitId + " .io-int").keyup(function(ioUnitId) {
            return function() {
              var ioIntVal = $("#iounit-" + ioUnitId + " .io-int").val();
              if (ioIntVal.length > 0 && parseInt(ioIntVal) !== 0) {
                simulator.IO.generateInterrupt(ioUnitId);
              }
            };
          }(ioUnitId));
          
          for (var i=0; i<memmapCount; i++) {
            var loc = i*4 + memmapStart;
            
            $(".io-loc-" + loc + " .io-mem-hex").keyup(function(ioUnitId, loc) {
              return function() {
                updateIoMemory(ioUnitId, loc, "hex");
              };
            }(ioUnitId, loc));
            
            $(".io-loc-" + loc + " .io-mem-dec").keyup(function(ioUnitId, loc) {
              return function() {
                updateIoMemory(ioUnitId, loc, "dec");
              };
            }(ioUnitId, loc));
            
            $(".io-loc-" + loc + " .io-mem-bin").keyup(function(ioUnitId, loc) {
              return function() {
                updateIoMemory(ioUnitId, loc, "bin");
              };
            }(ioUnitId, loc));
          }
          
          $("#iounit-" + ioUnitId + " .io-del").click(function() {
            removeIoUnit(ioUnitId);
          });
          
          ioUnit.onStateChange = function() {
            refreshIoUnitState(ioUnitId);
          };
          
          $("#ioUnitFormStatic").each(function() { this.reset(); });
          $("#frisc-ct-freq").remove();
          $("#frisc-ct-freq-label").remove();
          $("#frisc-pio-freq").remove();
          $("#frisc-pio-freq-label").remove();
        } catch (e) {
          simulatorLog("<span style='padding: 2px 4px 1px'; class='label label-important'><b>IO error</b></span> " + e.toString() + "");
        }
        
        return false;
      });
      
      function refreshIoUnitState(ioUnitId) {
        var ioUnit = simulator.IO.getIoUnit(ioUnitId);
        
        for (var i=0; i<ioUnit.memMapAddrCount; i++) {
          var ioMemoryAddress = i*4 + ioUnit.memMapAddrStart;
          var val = simulator.MEM.read(ioMemoryAddress);
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "dec").val(val.toString(10));
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "dec").text(val.toString(10));
          updateIoMemory(ioUnitId, ioMemoryAddress, "dec", true);
        }

        $("#iounit-" + ioUnitId + " .io-int").val(ioUnit.interruptState);
        $("#iounit-" + ioUnitId + " .io-int").text(ioUnit.interruptState);
      }
      
      function removeIoUnit(ioUnitId) {
        $("#iounit-" + ioUnitId).remove();
        simulator.IO.removeIoUnit(ioUnitId);
      }
      
      function formatHexNumber(num) {
        while (num.length < 8) {
          num = "0" + num;
        }
        
        return num.toUpperCase();
      }
      
      function formatBinNumber(num) {
        while (num.length < 32) {
          num = "0" + num;
        }
        
        return num;
      }
      
      function updateIoMemory(ioUnitId, ioMemoryAddress, valueType, blockPropagate) {
        var val = $(".io-loc-" + ioMemoryAddress + " .io-mem-" + valueType).val();
        
        if (isNaN(parseInt(val))) {
          val = 0;
        }

        if (valueType === 'hex') {
          val = parseInt(val, 16);          
          posval = val < 0 ? convertBinaryToInt(convertIntToBinary(val, 32), 0) : val;
          
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "dec").val(val.toString(10));
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "dec").text(val.toString(10));
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "bin").val(formatBinNumber(posval.toString(2)));
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "bin").text(formatBinNumber(posval.toString(2)));
        } else if (valueType === 'dec') {
          val = parseInt(val, 10);
          posval = val < 0 ? convertBinaryToInt(convertIntToBinary(val, 32), 0) : val;
          
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "hex").val(formatHexNumber(posval.toString(16)));
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "hex").text(formatHexNumber(posval.toString(16)));
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "bin").val(formatBinNumber(posval.toString(2)));
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "bin").text(formatBinNumber(posval.toString(2)));
        } else if (valueType === 'bin') {
          val = parseInt(val, 2);
          posval = val < 0 ? convertBinaryToInt(convertIntToBinary(val, 32), 0) : val;
                    
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "hex").val(formatHexNumber(posval.toString(16)));
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "hex").text(formatHexNumber(posval.toString(16)));
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "dec").val(val.toString(10));
          $(".io-loc-" + ioMemoryAddress + " .io-mem-" + "dec").text(val.toString(10));
        }
        
        if (typeof blockPropagate === 'undefined' || !(blockPropagate)) {
          var onc = simulator.IO.getIoUnit(ioUnitId).onStateChange;
          delete simulator.IO.getIoUnit(ioUnitId).onStateChange;
          simulator.MEM.write(ioMemoryAddress, val);
          simulator.IO.getIoUnit(ioUnitId).onStateChange = onc;
        }
      }

      function defineGenericIoUnitTypeForm() {
        $("#ioUnitMemmapCount").val(0);
        $("#ioUnitMemmapCount").attr("disabled", false);
      }
      
      function defineFriscCtIoUnitTypeForm() {
        $("#addIoUnit").before('<label id="frisc-ct-freq-label"> Frequency (Hz): </label>\n<input class="span1" type="text" style="margin-right: 4px;" id="frisc-ct-freq" value="1000"/>');
        $("#ioUnitMemmapCount").val(4);
        $("#ioUnitMemmapCount").attr("disabled", true);
      }
      
      function defineFriscPioIoUnitTypeForm() {
        $("#addIoUnit").before('<label id="frisc-pio-freq-label"> Frequency (Hz): </label>\n<input class="span1" type="text" style="margin-right: 4px;" id="frisc-pio-freq" value="1000"/>');
        $("#ioUnitMemmapCount").val(4);
        $("#ioUnitMemmapCount").attr("disabled", true);
      }
      
      function defineFriscDmaIoUnitTypeForm() {
        $("#ioUnitMemmapCount").val(6);
        $("#ioUnitMemmapCount").attr("disabled", true);
      }
    </script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-25513601-1']);
      _gaq.push(['_setDomainName', 'auto']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);
    
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
        'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
